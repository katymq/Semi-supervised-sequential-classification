# Simulations gpu
seed = 123
import os
import numpy as np
import matplotlib.pyplot as plt
from torchsummary import summary
import random
import torch
import configparser

random.seed(seed)     # python random generator
np.random.seed(seed)  # numpy random generator

torch.manual_seed(seed) # pytorch random generator
torch.cuda.manual_seed_all(seed) # for multi-gpu

torch.backends.cudnn.deterministic = True
torch.backends.cudnn.benchmark = False
#--------------------------------------------
from models.models_v3 import *
from utils.utils_semi import *
from utils.training import run_model_seq, num_param
#--------------------------------------------
path = os.getcwd()
folder_data = r'Data'
#-------------------------------
if torch.cuda.is_available():  
    device = "cuda:0" 
else:  
    device = "cpu"  
print('Your actual device',device)
#----------------------------------------------
# Load configuration files
data_config = configparser.ConfigParser()
data_config.read('data_config.ini')

model_config = configparser.ConfigParser()
model_config.read('model_config.ini')

# Get input values from configuration files or prompt user for input
type_image = data_config.get('data_settings', 'type_image', fallback=None)
if type_image=='-1':
    type_image = input("Enter the type of image (camel or cattle): ")
    data_config.set('data_settings', 'type_image', type_image)
size = data_config.getint('data_settings', 'size', fallback=None)
if size not in [128, 256]:
    size = int(input("Enter the size of the image (128 or 256): "))
    data_config.set('data_settings', 'size', str(size))
p = data_config.getint('data_settings', 'p', fallback=None)
if p<0 or p>100:
    p = int(input("Enter the percentage of missing labels (0 to 100): "))
    data_config.set('data_settings', 'p', str(p))
print(f"Data info: {type_image}, {size}, {p}")
#----------------------------------------------
# Path to save the model
path_data = os.path.join(path, folder_data, type_image+'_'+str(size))
print('Exist this folder', os.path.exists(path_data))
general_path  = os.path.join(os.getcwd(), 'Results_save_models') 
os.makedirs(general_path, exist_ok=True)
print('Saving our model in',general_path)
#----------------------------------------------
list_images = []
names_images = []
for data in sorted(os.listdir(path_data)):
    if data.endswith('.npy') and str(p) in data:
        list_images.append(np.load(os.path.join(path_data, data)))
        names_images.append(data[:-4])

index = data_config.getint('data_settings', 'index', fallback=None)
if index<0:
    index = int(input(f"Enter an index from 0 to {len(list_images)-1}: "))
    if index < 0 or index >= len(list_images):
        raise ValueError
    data_config.set('data_settings', 'index', str(index))

name_image = names_images[index]
print('index', index, name_image)
image_x, y_true, image_y = list_images[index]

x = torch.tensor(image_x.reshape(size*size, 1), dtype=torch.float32)
y = torch.tensor(image_y.reshape(size*size, 1), dtype=torch.float32)

x = x.to(device)
y = y.to(device)
# print(np.max(image_x), np.min(image_x), np.max(image_y), np.min(image_y))
#----------------------------------------------
#! General model settings
x_dim = 1
y_dim = 1
weight_decay_ = 1e-4
clip = 10
# add_loss =True # input("Enter 'True' if add_loss should be True, or 'False' otherwise: ").lower() == 'true'

z_dim = model_config.getint('model_settings', 'z_dim', fallback=None)
if z_dim <0:
    z_dim = int(input("Enter the value for z_dim: "))
    model_config.set('model_settings', 'z_dim', str(z_dim))

h_dim = model_config.getint('model_settings', 'h_dim', fallback=None)
if h_dim <0:
    h_dim = int(input("Enter the value for h_dim: "))
    model_config.set('model_settings', 'h_dim', str(h_dim))

num_neurons = model_config.getint('model_settings', 'num_neurons', fallback=None)
if num_neurons <0:
    num_neurons = int(input("Enter the value for num_neurons: "))
    model_config.set('model_settings', 'num_neurons', str(num_neurons))

learning_rate = model_config.getfloat('model_settings', 'learning_rate', fallback=None)
if learning_rate <0:
    learning_rate = float(input("Enter the learning rate: "))
    model_config.set('model_settings', 'learning_rate', str(learning_rate))

n_epochs = model_config.getint('model_settings', 'n_epochs', fallback=None)
if n_epochs <0:
    n_epochs = int(input("Enter the number of epochs: "))
    model_config.set('model_settings', 'n_epochs', str(n_epochs))

epoch_init = model_config.getint('model_settings', 'epoch_init', fallback=None)
if epoch_init <0:
    epoch_init = int(input("Enter the value for epoch_init: "))
    model_config.set('model_settings', 'epoch_init', str(epoch_init))

print_every = model_config.getint('model_settings', 'print_every', fallback=None)
if print_every <0:
    print_every = int(input("Enter the print interval: "))
    model_config.set('model_settings', 'print_every', str(print_every))

save_every = model_config.getint('model_settings', 'save_every', fallback=None)
if save_every <0:
    save_every = int(input("Enter the save interval: "))
    model_config.set('model_settings', 'save_every', str(save_every))

add_loss = model_config.get('model_settings', 'add_loss', fallback=None)
if add_loss:
     add_loss = input("Enter if additional loss function (True False): ")
     model_config.set('model_settings', 'add_loss', add_loss)

sel_model = model_config.get('model_settings', 'sel_model', fallback=None)
if sel_model== '-1':
    sel_model = input("Enter the selected model (tmm, vls, svrnn): ")
    model_config.set('model_settings', 'sel_model', sel_model)

setting = model_config.get('model_settings', 'setting', fallback=None)
if setting == '-1':
    setting = '' if add_loss else 'no_add'
    model_config.set('model_settings', 'setting', setting)


if sel_model == 'tmm':
    model = TMM(x_dim, z_dim, y_dim, h_dim, num_neurons, device, add_loss)
if sel_model == 'vls':
    model = VSL( x_dim, z_dim, y_dim, h_dim, num_neurons, device)
if sel_model == 'svrnn':
    model = SVRNN(x_dim, z_dim, h_dim, y_dim, num_neurons, device, add_loss)
#--------------------------------------------
# Save models
#--------------------------------------------
model.to(device)
optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate, weight_decay= weight_decay_)
print(f'{model.__class__.__name__ } has {num_param(model)} parameters to train \n')

data = model.__class__.__name__.casefold()+'_'+name_image+setting
path_save = os.path.join(general_path, data)
os.makedirs(path_save, exist_ok=True)
print(f'Actual path to save our models for {data} is \n {path_save} \n')
print( f'epoch_init = {epoch_init}, z_dim = {z_dim}, num_neurons = {num_neurons}, h_dim = {h_dim}, add_loss = {add_loss}, learning_rate = {learning_rate}, n_epochs = {n_epochs}, print_every = {print_every}, save_every = {save_every}, model = {model.__class__.__name__}')
#--------------------------------------------
# Train model
input('Press enter to continue: ')
#* Training
# Save configuration files
with open(os.path.join(general_path, f'data_config_{data}.ini'), 'w') as data_configfile:
    data_config.write(data_configfile)

with open(os.path.join(general_path,f'model_config_{data}.ini'), 'w') as model_configfile:
    model_config.write(model_configfile)


loss = run_model_seq(x, y, model, device,optimizer,clip, path_save, n_epochs,save_every, print_every, epoch_init)
plt.plot(loss)
plt.xlabel('Epochs')
plt.ylabel('Loss')
plt.title('Loss of ' + data+ ' with ' + str(n_epochs) + ' epochs')
plt.savefig(os.path.join(path_save, data + '_loss_' + str(n_epochs) +'.png'))
plt.show()
plt.close()

with open(os.path.join(path_save,'output.txt'), 'w') as f:
    print(f'image ={name_image}, epoch_init = {epoch_init}, z_dim = {z_dim}, num_neurons = {num_neurons}, h_dim = {h_dim}, add_loss = {add_loss}, learning_rate = {learning_rate}, n_epochs = {n_epochs}, print_every = {print_every}, save_every = {save_every}, model = {model.__class__.__name__}, num_param={num_param(model)}', file=f)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      